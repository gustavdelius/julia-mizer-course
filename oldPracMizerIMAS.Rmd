---
title: "Fishing Down the Marine Size Spectrum"
output: pdf_document
author: Julia Blanchard
date: 21/06/2017
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

In this practical you will get to explore the "mizer" R package and carry out some fishing scenarios to explore the ecosystem effects of fishing and potential trade-offs with fisheries yields.

mizer is a software package for implementing size spectrum ecological models using the R statistical
programming environment. The package has been developed to model marine ecosystems that are
subject to fishing.

There are three different kinds of size spectrum models in mizer, of increasing
complexity: 
1) community model: purely size-based and representative of a single but  "average" species across the whole community 
2) trait-based model, which disaggregates the size spectrum into differentgroups with different life-histories, through differences in each "species" asymptotic which determines
other life-history parameters such as the size at maturity (Hartvig et al. 2011, Andersen & Pedersen, 2010)
3) multispecies model - which has the same equations and parameters as the trait-based model but is parameterised to represent multiple species in a real system, where each species can have many differing species-specific traits (Blanchard et al. 2014). 

The community and trait-based models can be considered as simplifications of the multispecies model. mizer is able implement all three model versions using the same set of tools.

See the “mizer_vignette.pdf” in MyLO for detailed desciptions about the theory and concepts behind these models as well as the full set of equations.

The model framework builds on two central assumption and a number of lesser standard assumption.  

The first central assumption is that an individual can be characterized by its weight $w$ and its trait or species group $i$ only. The aim of the model is to calculate the size- and trait-spectrum ${\cal N}_i(w)$ which is the density of individuals such that ${\cal N}_i(w)dw$ is the number of individuals in the interval $[w:w+dw]$. The dimensions of the size spectrum are numbers per weight per volume.  Scaling from individual-level processes of growth and mortality to the size spectrum of each trait group is achieved by means of the McKendrik-von Foerster equation, which is simply a conservation equation:

$$
  \frac{\partial N_i(w)}{\partial t} + \frac{\partial g_i(w) N_i(w)}{\partial w} = -\mu_i(w) N_i(w)
$$


where individual growth $g_i(w)$ and mortality $\mu_i(w)$ are both determined by the availability of food from the other species plus a background resource, $N_R(w)$, and predation by the other species. The conservation equation is supplemented by a boundary condition at the boundary at weight $w_0$ where the flux of individuals (numbers per time) $g_i(w_0) N_i(w_0)$ is determined by the reproduction of offspring by mature individuals in the population $R_i$:

$$
  g_i(w_0)N_i(w_0) = R_i.
$$

The second central assumption is that the preference of food is determined by individual weight combined with a species preference. The preference for prey weight is described by the log-normal selection model  which describes prey preference in terms of the ratio between the weight of predators $w$ and prey of weight $w_p$:

$$
  \phi(w_p/w) = \exp \left[ \frac{-(\ln(w/(w_p \beta_i)))^2}{2\sigma_i^2} \right],
$$
where $\beta_i$ is the preferred predator-prey mass ratio and $\sigma_i$ the width of the weight selection function.

The rest of the formulation of the model rests on a number of ``standard'' assumptions from ecology and fisheries science about how encounters between predators and prey leads to growth $g_i(w)$ and recruitment $R_i$ of the predators, and mortality of the prey $\mu_i(w)$. We will explore some of these.


## Getting Started

To install mizer you need to first install and then load the package:

```{r message=FALSE, warning=FALSE}
rm(list=ls())
install.packages("mizer")
library(mizer)


```

## Part 1: Community Model

First we will explore the simplest model, the community model, where there is a single consumer size spectrum plus a resource spectrum. To have a look at the paramters of the model

```{r message=FALSE, warning=FALSE}
?set_community_model
```

We will set up the parameters for the community model, here, based on the default parameter values.

```{r message=FALSE, warning=FALSE}
params <- set_community_model(knife_edge_size = 1000)

```

The we can run the community model for 100 years and plot the results.
```{r message=FALSE, warning=FALSE}
sim <- project(params, effort = 0, t_max = 100, dt=0.1)
plot(sim)
```

Note that sim is an S4 object that stores all of the results
```{r message=FALSE, warning=FALSE}
slotNames(sim)
```

What happens if we were to start fishing? Note that although the parameter is called "effort" this is the instantaneous fishing mortality rate applied equally across a range of size classes.

```{r message=FALSE, warning=FALSE}
sim1 <- project(params, effort = 0.5, t_max = 100, dt=0.1)
plot(sim1)
```

How does this differ from the unfished example?
```{r message=FALSE, warning=FALSE}
bio.nf<-sim@n
bio.f<-sim1@n
size.class<-sim@params@w
plot(size.class,bio.nf[101,1,],log="xy",type="l",xlab="Body mass",ylab="Abundance Density")
lines(size.class,bio.f[101,1,],lty=2)
```


The above plot shows that the density of large size classes is substantially reduced with the addition of fishing mortality.


### Exercise

Change the range of size classes fished to examine how this could affect the community. In  set_community_model() there are a few other parameters that can be changed. One is associated with the selctivity of the fishing gear in terms of the minimum sized fish assuming a "knife-edged" or flat fishing pattern. If we reduce the smallest sizes of to include very small fish caught how does this change the fished community?

```{r message=FALSE, warning=FALSE}
params <- set_community_model(knife_edge_size = 1)
sim3 <- project(params, effort = 0.5, t_max = 100, dt=0.1)
plot(sim3)
```

Now compare this with the previous scenarios.

```{r}

bio.fsmall<-sim3@n
plot(size.class,bio.nf[101,1,],log="xy",type="l",xlab="Body mass",ylab="Abundance Density")
lines(size.class,bio.fsmall[101,1,],lty=3)
lines(size.class,bio.f[101,1,],lty=2)

```

Now try to change the  fishing stategy to a dynamic one that changes through time. Let's start with no fishing for 75 years and then ramp this up to 0.5 for 25 years. This time let's have a look at how the total biomass of the community changes through time.


```{r message=FALSE, warning=FALSE}
params <- set_community_model(knife_edge_size = 1)
gear_names <- c("Community")
times <- seq(from = 1, to = 100, by = 1)
effort_array <- array(NA, dim = c(length(times), length(gear_names)),
    dimnames = list(time = times, gear = gear_names))
effort_array[,"Community"] <- c(rep(0,75),rep(0.9,25))
sim4 <- project(params, effort = effort_array, t_max = 100, dt=0.1)
B<-getBiomass(sim4)
plot.ts(B,ylab="Total Biomass")
abline(v=75)

```

### Exploring the effects of other parameters

The parameters that control the size-selection of the predators are the preferred predator prey mass ratio $\beta$ and the width of the prey size window $\sigma$. A smaller value of $\beta$ indicates that predators prefer prey sizes closer to their own size. A smaller value of $\sigma$ indicates that the range of prey sizes consumed is smaller.  Do these assumptions affect how the community responds with and without fishing?

```{r}
params_beta <- set_community_model(knife_edge_size = 1,beta=10000,sigma=2)
sim_beta <- project(params_beta, effort = effort_array, t_max = 100, dt=0.1)
B_beta<-getBiomass(sim_beta)
plot.ts(B_beta,ylab="Total Biomass",lty=2)
lines(B,lty=1)
abline(v=75)

```



## Part 2: Trait-based model

The second type of model in mizer is the trait-based model, where species are defined by different life history traits. Now let's set up a simple trait-based model to have 10 species, with asymptotic sizes ranging from 10 g to 100 kg. All the other parameters have default values and no fishing. First let's also clear the workspace.

```{r message=FALSE, warning=FALSE}

?set_trait_model
t.params <- set_trait_model(no_sp = 10, min_w_inf = 10, max_w_inf = 1e5)
#t.params@species_params$r_max<-rep(5^20,10)
summary(t.params)
t.sim <- project(t.params, t_max = 500,effort=0)
plot(t.sim)


rd<-getRDD(t.params,t.sim@n[500,,],t.sim@n_pp[500,])
ri<-getRDI(t.params,t.sim@n[500,,],t.sim@n_pp[500,])

ri[,]/rd[,]

```

Or just plot your own size spectrum rather than using the built-in function. Below we have selected to plot the size spectra at the final time step, which is indexed as "76".


```{r message=FALSE, warning=FALSE}
nss<-t.sim@n
t.size.class<-t.sim@params@w
plot(t.size.class,colSums(nss[76,,]),type="l",log="xy",xlab="Body mass",
     ylab="Abundance density") 
for(i in 1:10)
{
	lines(t.size.class, nss[76,i,],lty=i+1) # plot each species
}

```

To set up the trait-based model to have fishing we set up the MizerParams  object in exactly the same way as we did before but here the knife_edge_size  argument is explicitly passed into the params object for clarity. Now we simulate with fishing. Here, we use a fishing mortality (called effort) of 0.75 for all species but fishing only from sizes 1000 grams and larger.

```{r}
t.params_knife <- set_trait_model(no_sp = 10, min_w_inf = 10, max_w_inf = 1e5,knife_edge_size = 100)

t.sim_f <- project(t.params_knife, effort = 0.75, t_max = 75)
plot(t.sim_f)

```


The mizer package has some short-cuts for you to calculate different types of indicators ( see page 71 of the mizer_vignette). Let's compare a couple of indicators before and after fishing.

```{r}

par(mfrow=c(3,1),mai=c(0.3,1,0.2,1))
plot.ts(getProportionOfLargeFish(t.sim),ylab="Proportion of Large Fish")
lines(getProportionOfLargeFish(t.sim_f),lty=2)

plot.ts(getCommunitySlope(t.sim)[,"slope"],ylab="Community Slope",ylim=c(-3,-0.6))
lines(getCommunitySlope(t.sim_f)[,"slope"],lty=2)

plot.ts(getMeanMaxWeight(t.sim)[,2],ylab="Mean Maximum Weight",log="y")
lines(getMeanMaxWeight(t.sim_f)[,2],lty=2)


```


### Size-selective fishing example

To set up the model carry out different size-selective fishing for each species we can set the position of the knife-edge to occurr at 0.05 x the asymptotic size i.e. the selectivity parameters will be different for each species and will depend on the asymptotic size.

```{r}

no_sp <- 10
min_w_inf <- 10
max_w_inf <- 1e5
w_inf <- 10^seq(from=log10(min_w_inf), to = log10(max_w_inf), length=no_sp)
knife_edges <- 0.05*w_inf 
t.params_selective <- set_trait_model(no_sp = 10, min_w_inf = 10, max_w_inf = 1e5, knife_edge_size = knife_edges)
t.sim_sf <- project(t.params_selective, effort = 0.75, t_max = 75)
plot(t.sim_sf)

```

We might like to compare the yields from an unselective (simple knife-edge) and a selective fishery. To do we can use some of the short-cut functions below.

```{r}
plot.ts(rowSums(getYield(t.sim_sf)),lty=2,ylab="Yield")
lines(rowSums(getYield(t.sim_f)),lty=1)
```

Have a look at the yields for each species at the end of the time simulation.

```{r}
par(mfrow=c(2,1),mai=c(0.5,1,0.3,1))
barplot(getYield(t.sim_sf)[75,],main="Selective fishing",ylab="Yield",xlab="",ylim=c(0,0.01))
barplot(getYield(t.sim_f)[75,],main="Unselective fishing",ylab="Yield",xlab="Species", ylim=c(0,0.01))
```

## Part 3: Exploring a multispecies North Sea model

The mizer package contains an example multspecies model using parameters based on a published example (Blanchard et al. 2014, J Applied Ecology). Here each species has a different set of parameters as well as different gears fishing different species.

```{r message=FALSE, warning=FALSE}
data(NS_species_params_gears)
data(inter)
params <- MizerParams(NS_species_params_gears, inter)
# Lets examine the inputs here
summary(params)
# Notice the fishing fleets

```

Our initial model will be run without fishing to equilibrium, where time to equilbrium is assumed to be 100 years.
```{r}
sim.ns.e <- project(params, t_max = 100,effort=0,dt=0.1)
plot(sim.ns.e)
n_equib <- sim.ns.e@n[101,,]
n_pp_equib <- sim.ns.e@n_pp[101,]


```

As mentioned above fishing mortality rate is a product of the fishing effort, catchability and selectivity. By default the catchability is 1. For a fully selected species (i.e. selectivity = 1), F is therefore equal to the effort in this model. The units of effort are unimportant here, so long as the product of effort, catchability and selectivity are the same as the desired F (i.e. 'per unit time')

We can apply a dynamic fishing example here where fishing effort varies through time for each gear. Here imagine the different gears start out low and expand at different times.

  After 10 years a pelagic fishery starts (increases from 0 to 1 over 10 yrs)
  After 30 years a beam fishery starts (increases from 0 to 0.75 over 10 yrs)
  After 50 years an otter fishery starts (increases from 0 to 0.9 over 10 yrs)
  After 70 years an industrial fishery starts (increases from 0 to 1.5 over 10 yrs)



```{r}
# Pelagic, Beam, Otter, Industrial
gear_names <- c("Pelagic","Beam","Otter","Industrial")
project_time <- 100
fishing_effort <- array(0, dim=c(project_time, 4), dimnames=list(time=1:project_time, gear=gear_names))
fishing_effort[,"Pelagic"] <- c(rep(0,10),seq(from = 0, to = 1, length = 10), rep(1,80))
fishing_effort[,"Beam"] <- c(rep(0,30),seq(from = 0, to = 0.75, length = 10), rep(0.75,60))
fishing_effort[,"Otter"] <- c(rep(0,50),seq(from = 0, to = 0.9, length = 10), rep(0.9,40))
fishing_effort[,"Industrial"] <- c(rep(0,70),seq(from = 0, to = 1.5, length = 10), rep(1.5,20))

# Have a quick look at what the fishing efforts will do through time
plot(x = 1:project_time, y = seq(from=0,to=1,length=project_time), type="n", xlab = "Years", 
     ylab="Fishing effort", ylim=c(0,1.5))
for (i in 1:4){
    lines(x=1:project_time, y = fishing_effort[,i], lty=i)
}
legend(x="bottomright",legend=c("Pelagic", "Beam", "Otter", "Industrial"), lty=1:4)


```


If that looks reasonable, run the simulation using the equilibrium  model without fishing as the initial values for the model. Then let's have a look at the yields of different species.


```{r message=FALSE, warning=FALSE}
NS_sim <- project(params, effort=fishing_effort, initial_n = n_equib, initial_n_pp = n_pp_equib)

yield <- getYield(NS_sim)
install.packages("reshape")
library(reshape)
library(ggplot2)

yield.long <-melt(yield)
ggplot(yield.long,aes(x = time, y = value)) + geom_line(aes(x =time, y = value,color=sp)) +
ylab("Yield") 
```

Calculate the total multispecies yield and make a quick plot:

```{r message=FALSE, warning=FALSE}

total <- rowSums(yield)

plot.ts(total,ylab="Total Yield")

```


Calculate several types of the indicators. First, we will get the "Spawning Stock Biomass" (SSB) for each population.


```{r}
ssb <- getSSB(NS_sim)
# Rescale ssb to be relative to the unfished ssb
rescale_ssb <- sweep(ssb,2,ssb[1,],"/")

rescale_ssb.long <-melt.array(rescale_ssb)

ggplot(rescale_ssb.long,aes(x = time, y = value)) + geom_line(aes(x =time, y = value,color=sp)) +
ylab("SSB") +
geom_hline(aes(yintercept=0.1), colour="grey",lty=2)
    

```

The SSB for one species (Sandeel) had dropped to < 10% of it's unfished biomass following the introduction of the Industrial fishery. This threshold of < 10% is often used as an indicator of population collapse.

Next we can calculate some community level indicators. We need to set the size ranges to include in our calculations.

```{r}
min_w <- 1
max_w <- 1e6
threshold_w <- 100
lfi <- getProportionOfLargeFish(NS_sim, min_w=min_w, max_w=max_w, threshold_w=threshold_w)
mw <- getMeanWeight(NS_sim, min_w=min_w, max_w=max_w)
mmw <- getMeanMaxWeight(NS_sim, min_w=min_w, max_w=max_w, measure="biomass")
slope <- getCommunitySlope(NS_sim, min_w=min_w, max_w=max_w)[,"slope"]

par(mfrow=c(2,2))
plot.ts(slope)
plot.ts(lfi)
plot.ts(mw)
plot.ts(mmw)


```

If we had not examined each species response to the fishing development or only looked at one of the community indicator (e.g. LFI) we might have (incorrectly) inferred that the community was improving through time. The changes in some of the size-based indicators suggest relative more large fish than smaller ones towards the end of the time series. However, this is in part because the biomass of small species (Sandeel and Sprat) have declined dramatically and the biomass of a larger species (Haddock) has not been as heavily impacted relative to the others. The indicators are also sensitive to what sizes and species are included in their calculation, which you can test above. This emphasises the need to look in detail across a range of indicators, as well as their sensitivity and specificity to particular fishing patterns.


### Assignment

 1. Design your own multispecies fishing scenarios to compare (e.g. size-selective vs unselective, one large species fished vs all small species fished, etc.)   and describe describe why you have chosen these to contrast. (5pts)	Feel free to set up your won "fictious' model!

 2. Carry our simulations. Describe how the community changes under each scenario and relative to the unexploited community (5pts)	

3. Repeat step 2 with different paramneter values of your choice but change one of the parameter values. Describe the results. What are your conclusions about the effects of the fishing scenanrios on the community and how sensitive are your conclusions to these parameters changes?  (5pts)
 	
# For further details on the models and help consult the mizer_vignette.pdf.	
	 	

##### Fantasy mizer
## Species specific parameters
```{r}


fic.params<-data.frame(matrix(0,5,0))
fic.params$species<-c("Blinky","Fishtronaut", "Fluffy","Mermaids","Nessie")
fic.params$w_inf<-c(400,100,3000,40000,100000)
fic.params$w_mat<-c(100,20,500,10000,20000)
fic.params$z0<-c(0.2,0.2,0.14,0.12,0.25) ## mu_0
fic.params$r_max<-c(1e8,1e9,5e6,1e3,1e4)
fic.params$beta<-c(3210,42100,3200,200,30)
fic.params$sigma<-c(1.2,1.4,1.8,2,3)
fic.params$ks<-c(1,1,0.9,0.91,0.54)
fic.params$h<-c(10,14,30,20,32)
fic.params$gamma<-c(1e-9,2e-11,1e-11,6e-10,7e-12)

# interaction matrix
fic.inter<-matrix(1,5,5)
colnames(fic.inter)<-rownames(fic.inter)<-fic.params$species
fic.inter[1,1]<-1;fic.inter[1,2]<-0.8;fic.inter[1,3]<-0.4;fic.inter[1,4]<-0.9;fic.inter[1,5]<-0.8
fic.inter[2,1]<-0.53;fic.inter[2,2]<-0.35;fic.inter[2,3]<-0.6;fic.inter[2,4]<-0.8;fic.inter[2,5]<-0.42
fic.inter[3,1]<-1;fic.inter[3,2]<-0.76;fic.inter[3,3]<-0.5;fic.inter[3,4]<-1;fic.inter[3,5]<-0.72
fic.inter[4,1]<-0.05;fic.inter[4,2]<-0.8;fic.inter[4,3]<-0;fic.inter[4,4]<-0;fic.inter[4,5]<-0.8
fic.inter[5,1]<-1;fic.inter[5,2]<-0.74;fic.inter[5,3]<-1;fic.inter[5,4]<-1;fic.inter[5,5]<-0.9;

# set up and run!
params.fic <- MizerParams(fic.params, fic.inter,r_pp=0.1,lambda=2.2)
sim.fic <- project(params.fic, t_max = 100,dt=0.1)
plot(sim.fic)




```

